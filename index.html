<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestDash Quantum v12.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05070a; --card: #0f121d; --primary: #7c3aed; --accent: #2dd4bf;
            --success: #10b981; --danger: #f43f5e; --text: #f1f5f9; --sub: #64748b; --border: #1e293b;
        }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; transition: 0.2s; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header & Tools */
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 25px; padding: 20px; background: var(--card); border-radius: 24px; border: 1px solid var(--border); }
        .tool-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px; }
        
        .box { background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 20px; }
        .stat-main { font-size: 32px; font-weight: 800; display: block; margin: 10px 0; letter-spacing: -1px; }
        .label { font-size: 11px; text-transform: uppercase; color: var(--sub); font-weight: 700; letter-spacing: 1px; }

        /* Magic Number & Snowball */
        .magic-card { background: linear-gradient(135deg, #1e1b4b, #312e81); padding: 20px; border-radius: 20px; border: 1px solid var(--primary); }
        .snowball-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        /* Buttons */
        .btn { padding: 10px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; font-size: 13px; display: inline-flex; align-items: center; gap: 8px; }
        .btn-p { background: var(--primary); color: white; }
        .btn-s { background: #1e293b; color: white; border: 1px solid var(--border); }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--sub); font-size: 10px; padding: 12px; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; font-weight: 600; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; }
        .b-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .b-error { background: rgba(244, 63, 94, 0.1); color: var(--danger); }
        
        .blur { filter: blur(8px); }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 26px;">InvestDash <span style="color:var(--primary)">Quantum v12</span></h1>
            <p id="aiReport" style="color:var(--sub); margin:5px 0 0; font-size:13px;">Inicie a an√°lise carregando seu arquivo.</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="exportReport()" class="btn btn-s">üìã Relat√≥rio</button>
            <button onclick="togglePrivacy()" class="btn btn-s">üëÅÔ∏è Ocultar</button>
            <label for="fIn" class="btn btn-p">‚ö° Importar Planilha</label>
            <input type="file" id="fIn" accept=".xlsx">
        </div>
    </div>

    <div class="tool-grid">
        <div class="box magic-card">
            <span class="label" style="color:var(--accent)">ü™Ñ Efeito Bola de Neve (Magic Number)</span>
            <div id="magicList" style="margin-top:15px; font-size:13px;">
                Aguardando dados...
            </div>
        </div>
        <div class="box">
            <span class="label">üí∞ Patrim√¥nio L√≠quido</span>
            <span class="stat-main privacy" id="vPat">R$ 0,00</span>
            <div style="display:flex; justify-content:space-between; font-size:11px;">
                <span id="vLucro" class="privacy" style="color:var(--success)">+ R$ 0,00</span>
                <span id="vYield">YoC: 0.0%</span>
            </div>
        </div>
        <div class="box">
            <span class="label">üì° Score de Risco IA</span>
            <span class="stat-main" id="vRisk">--</span>
            <div id="vRiskDesc" style="font-size:11px; color:var(--sub)">Analisando correla√ß√£o de ativos...</div>
        </div>
    </div>

    <div class="tool-grid" style="grid-template-columns: 2fr 1fr;">
        <div class="box" style="overflow-x:auto;">
            <h3 style="margin:0 0 15px 0; font-size:16px;">Calculadora de Pre√ßo Teto & Dividendos</h3>
            <table id="mainTable">
                <thead>
                    <tr>
                        <th>Ativo</th>
                        <th>Cota√ß√£o</th>
                        <th>Pre√ßo Teto</th>
                        <th>Margem</th>
                        <th>Status IA</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="box">
            <h3 style="margin:0 0 15px 0; font-size:16px;">Concentra√ß√£o Setorial</h3>
            <canvas id="cSetor" height="250"></canvas>
        </div>
    </div>
</div>

<script>
    let db = {}; let charts = {};
    const brl = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

    window.onload = () => {
        const saved = localStorage.getItem('investDash_v12');
        if(saved) { db = JSON.parse(saved); analyze(); }
    };

    document.getElementById('fIn').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = evt => {
            const wb = XLSX.read(evt.target.result, {type:'binary'});
            db = {
                c: XLSX.utils.sheet_to_json(wb.Sheets["CARTEIRA"]),
                d: XLSX.utils.sheet_to_json(wb.Sheets["DIVIDENDOS"])
            };
            localStorage.setItem('investDash_v12', JSON.stringify(db));
            analyze();
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    function analyze() {
        if(!db.c) return;
        const cart = db.c.filter(i => i.ATIVO);
        const totalPat = cart.reduce((a,b) => a + (parseFloat(b['CART. ATUAL'])||0), 0);
        const totalInv = cart.reduce((a,b) => a + (parseFloat(b['CUSTO TOTAL'])||0), 0);
        const totalDiv = db.d.reduce((a,b) => a + (parseFloat(b.Valor)||0), 0);

        // KPIs
        document.getElementById('vPat').innerText = brl(totalPat);
        document.getElementById('vLucro').innerText = "+ " + brl((totalPat - totalInv) + totalDiv);
        document.getElementById('vYield').innerText = "YoC: " + ((totalDiv/(totalInv||1))*100).toFixed(2) + "%";

        // IA: Score de Risco (Baseado em concentra√ß√£o)
        const maxSetor = {}; cart.forEach(c => maxSetor[c.SEGMENTO] = (maxSetor[c.SEGMENTO] || 0) + (c['CART. ATUAL']/totalPat));
        const riskScore = (Math.max(...Object.values(maxSetor)) * 100).toFixed(0);
        document.getElementById('vRisk').innerText = riskScore > 40 ? "ALTO" : "BAIXO";
        document.getElementById('vRiskDesc').innerText = riskScore > 40 ? "‚ö†Ô∏è Muita concentra√ß√£o em um s√≥ setor." : "‚úÖ Carteira bem diversificada.";

        // Magic Number & Relat√≥rio
        updateMagicNumber(cart);
        renderTable(cart);
        renderCharts(cart);
        
        document.getElementById('aiReport').innerText = `ü§ñ IA: Voc√™ possui ${cart.length} ativos. Seu melhor rendimento √© ${cart.sort((a,b)=>b.DIVIDENDOS-a.DIVIDENDOS)[0].ATIVO}.`;
    }

    function updateMagicNumber(cart) {
        const list = document.getElementById('magicList');
        list.innerHTML = '';
        cart.slice(0, 4).forEach(at => {
            const divMensal = (parseFloat(at.DIVIDENDOS) / 12) || 0;
            const cot = parseFloat(at['COTA√á√ÉO ATUAL']) || 1;
            const progress = (divMensal / cot) * 100;
            list.innerHTML += `
                <div class="snowball-item">
                    <span>${at.ATIVO}</span>
                    <span style="color:var(--accent)">${progress >= 100 ? '‚úÖ 1+ Cota/m√™s' : progress.toFixed(1)+'% para 1 cota'}</span>
                </div>`;
        });
    }

    function renderTable(cart) {
        const tb = document.querySelector('#mainTable tbody');
        tb.innerHTML = '';
        cart.forEach(at => {
            const cot = parseFloat(at['COTA√á√ÉO ATUAL']) || 0;
            const teto = (parseFloat(at.DIVIDENDOS)/at['QTDE ATUAL'])/0.06 || 0;
            const margem = teto > 0 ? ((teto/cot - 1)*100).toFixed(1) : 0;
            
            tb.innerHTML += `<tr>
                <td>${at.ATIVO}</td>
                <td class="privacy">${brl(cot)}</td>
                <td class="privacy">${brl(teto)}</td>
                <td style="color:${margem > 0 ? 'var(--success)' : 'var(--danger)'}">${margem}%</td>
                <td><span class="badge ${margem > 10 ? 'b-success' : 'b-error'}">${margem > 10 ? 'FORTE COMPRA' : 'HOLD'}</span></td>
            </tr>`;
        });
    }

    function renderCharts(cart) {
        const s = {}; cart.forEach(c => s[c.SEGMENTO] = (s[c.SEGMENTO] || 0) + (parseFloat(c['CART. ATUAL'])||0));
        if(charts.s) charts.s.destroy();
        charts.s = new Chart(document.getElementById('cSetor'), {
            type: 'polarArea',
            data: { labels: Object.keys(s), datasets: [{ data: Object.values(s), backgroundColor: ['#7c3aed', '#2dd4bf', '#10b981', '#f59e0b', '#f43f5e'] }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function togglePrivacy() {
        document.querySelectorAll('.privacy').forEach(el => el.classList.toggle('blur'));
    }

    function exportReport() {
        const pat = document.getElementById('vPat').innerText;
        const texto = `üìä RELAT√ìRIO DE INVESTIMENTOS\nPatrim√¥nio: ${pat}\nStatus: ${document.getElementById('vRiskDesc').innerText}\n\nGerado por InvestDash Quantum.`;
        navigator.clipboard.writeText(texto);
        alert("Relat√≥rio copiado para a √°rea de transfer√™ncia!");
    }
</script>
</body>
</html>
