<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestDash Elite v10.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0f1a; --card: #151c2c; --primary: #6366f1; --accent: #c084fc;
            --success: #10b981; --danger: #f43f5e; --text: #f8fafc; --sub: #64748b; --border: #2d3748;
        }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 15px; transition: 0.3s; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Header Moderno */
        .header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 25px; border-radius: 24px; border: 1px solid var(--border); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .ai-status { background: rgba(99, 102, 241, 0.1); border-left: 4px solid var(--primary); padding: 15px; border-radius: 12px; margin-top: 15px; width: 100%; font-size: 14px; line-height: 1.5; }

        /* KPI Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: var(--card); padding: 22px; border-radius: 20px; border: 1px solid var(--border); position: relative; }
        .stat-card span { font-size: 11px; font-weight: 700; color: var(--sub); text-transform: uppercase; letter-spacing: 1px; }
        .stat-card h2 { margin: 8px 0 0; font-size: 24px; font-weight: 800; }
        
        /* Barra de Meta */
        .meta-box { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 25px; }
        .progress-container { background: #0f172a; height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .progress-bar { background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; height: 100%; transition: 1.5s cubic-bezier(0.1, 0, 0, 1); }

        /* Gr√°ficos */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 25px; }
        @media(min-width: 1024px) { .main-grid { grid-template-columns: 2fr 1fr; } }
        .chart-container { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid var(--border); min-height: 350px; }

        /* Tabela Inteligente */
        .table-section { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid var(--border); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { text-align: left; padding: 15px; color: var(--sub); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        /* Utilidades */
        .btn { padding: 10px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; transition: 0.2s; font-size: 13px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-ghost { background: transparent; color: var(--text); border: 1px solid var(--border); }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .blur { filter: blur(6px); pointer-events: none; }
        .badge { padding: 5px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; }
        .badge-buy { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-wait { background: rgba(244, 63, 94, 0.1); color: var(--danger); }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1 style="margin:0; font-size: 28px;">InvestDash <span style="color:var(--primary)">Elite</span></h1>
            <p style="margin:5px 0 0; color:var(--sub); font-size:14px;">Terminal de Intelig√™ncia Financeira</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="togglePrivacy()" class="btn btn-ghost">üëÅÔ∏è Modo Privado</button>
            <label for="fIn" class="btn btn-primary">üîå Importar XLSX</label>
            <input type="file" id="fIn" accept=".xlsx">
            <button onclick="clearCache()" class="btn btn-ghost" style="color:var(--danger)">üóëÔ∏è Limpar</button>
        </div>
        <div id="aiStatus" class="ai-status">
            ü§ñ <b>Analista IA:</b> Sistema pronto. Carregue sua planilha de controle para iniciar o diagn√≥stico da carteira.
        </div>
    </div>

    <div class="meta-box">
        <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:800; color:var(--sub);">
            <span>META PATRIMONIAL: R$ 100.000,00</span>
            <span id="metaPct">0%</span>
        </div>
        <div class="progress-container"><div id="metaBar" class="progress-bar"></div></div>
    </div>

    <div class="stats-grid">
        <div class="stat-card"><span>Patrim√¥nio Atual</span><h2 id="sPat" class="val">R$ 0,00</h2></div>
        <div class="stat-card"><span>Dividendos Totais</span><h2 id="sDiv" class="val" style="color:var(--success)">R$ 0,00</h2></div>
        <div class="stat-card"><span>Yield Global (YoC)</span><h2 id="sYoc">0,00%</h2></div>
        <div class="stat-card"><span>M√©dia Mensal</span><h2 id="sMed" class="val" style="color:var(--primary)">R$ 0,00</h2></div>
    </div>

    <div class="main-grid">
        <div class="chart-container">
            <h3 style="margin-top:0">Proje√ß√£o de Renda Acumulada</h3>
            <canvas id="chartLine"></canvas>
        </div>
        <div class="chart-container">
            <h3 style="margin-top:0">Aloca√ß√£o Estrat√©gica</h3>
            <canvas id="chartPie"></canvas>
        </div>
    </div>

    <div class="table-section">
        <h3 style="margin-top:0">Raio-X de Ativos e Pre√ßo Teto IA</h3>
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Ativo</th>
                    <th>Qtd</th>
                    <th>Pre√ßo M√©dio</th>
                    <th>Cota√ß√£o</th>
                    <th>Margem Seg.</th>
                    <th>Pre√ßo Teto IA</th>
                    <th>Recomenda√ß√£o</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let rawData = {}; 
    let charts = {};
    const fmt = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

    // Carregar dados salvos ao iniciar
    window.onload = () => {
        const saved = localStorage.getItem('investDash_v10');
        if (saved) {
            rawData = JSON.parse(saved);
            renderDashboard();
            updateAIInsight("Dados recuperados com sucesso. Analisando tend√™ncias...");
        }
    };

    document.getElementById('fIn').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = evt => {
            const wb = XLSX.read(evt.target.result, {type:'binary'});
            rawData = {
                c: XLSX.utils.sheet_to_json(wb.Sheets["CARTEIRA"]),
                d: XLSX.utils.sheet_to_json(wb.Sheets["DIVIDENDOS"]),
                a: XLSX.utils.sheet_to_json(wb.Sheets["APORTE"])
            };
            localStorage.setItem('investDash_v10', JSON.stringify(rawData));
            renderDashboard();
            updateAIInsight("Nova planilha processada. Algoritmos de recomenda√ß√£o atualizados.");
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    function renderDashboard() {
        if (!rawData.c) return;
        const cart = rawData.c.filter(i => i.ATIVO);
        const totalPat = cart.reduce((a, b) => a + (parseFloat(b['CART. ATUAL']) || 0), 0);
        const totalInv = cart.reduce((a, b) => a + (parseFloat(b['CUSTO TOTAL']) || 0), 0);
        const totalDiv = rawData.d.reduce((a, b) => a + (parseFloat(b.Valor) || 0), 0);
        const meses = [...new Set(rawData.d.map(d => d.M√äS))].length || 1;

        // Atualizar KPIs
        document.getElementById('sPat').innerText = fmt(totalPat);
        document.getElementById('sDiv').innerText = fmt(totalDiv);
        document.getElementById('sYoc').innerText = ((totalDiv / (totalInv || 1)) * 100).toFixed(2) + "%";
        document.getElementById('sMed').innerText = fmt(totalDiv / meses);

        // Barra de Meta (Base R$ 100k)
        const progresso = Math.min(100, (totalPat / 100000) * 100);
        document.getElementById('metaBar').style.width = progresso + "%";
        document.getElementById('metaPct').innerText = progresso.toFixed(1) + "%";

        renderTable(cart);
        renderCharts(cart, rawData.d);
    }

    function renderTable(cart) {
        const tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = '';
        cart.forEach(at => {
            const cot = parseFloat(at['COTA√á√ÉO ATUAL']) || 0;
            const pm = parseFloat(at['PRE√áO M√âDIO']) || 0;
            const proventoAnual = (parseFloat(at.DIVIDENDOS) / (at['QTDE ATUAL'] || 1));
            const precoTeto = proventoAnual / 0.06; // Bazin 6%
            const margem = pm > 0 ? ((cot / pm - 1) * 100).toFixed(1) : 0;

            tbody.innerHTML += `
                <tr>
                    <td><b>${at.ATIVO}</b><br><small style="color:var(--sub)">${at.SEGMENTO}</small></td>
                    <td>${at['QTDE ATUAL']}</td>
                    <td class="val">${fmt(pm)}</td>
                    <td class="val">${fmt(cot)}</td>
                    <td style="color:${margem < 0 ? 'var(--success)' : 'var(--danger)'}">${margem}%</td>
                    <td class="val">${fmt(precoTeto)}</td>
                    <td><span class="badge ${cot < precoTeto ? 'badge-buy' : 'badge-wait'}">
                        ${cot < precoTeto ? 'üî• OPORTUNIDADE' : '‚úã AGUARDAR'}
                    </span></td>
                </tr>
            `;
        });
    }

    function renderCharts(cart, divs) {
        // Line Chart
        const hist = {}; divs.forEach(d => hist[d.M√äS] = (hist[d.M√äS] || 0) + d.Valor);
        if(charts.l) charts.l.destroy();
        charts.l = new Chart(document.getElementById('chartLine'), {
            type: 'line',
            data: { labels: Object.keys(hist), datasets: [{ label: 'Proventos Mensais', data: Object.values(hist), borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99, 102, 241, 0.1)' }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // Pie Chart
        const secao = {}; cart.forEach(c => secao[c.TIPO] = (secao[c.TIPO] || 0) + c['CART. ATUAL']);
        if(charts.p) charts.p.destroy();
        charts.p = new Chart(document.getElementById('chartPie'), {
            type: 'doughnut',
            data: { labels: Object.keys(secao), datasets: [{ data: Object.values(secao), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '80%' }
        });
    }

    function updateAIInsight(msg) {
        document.getElementById('aiStatus').innerHTML = `ü§ñ <b>Analista IA:</b> ${msg}`;
    }

    function togglePrivacy() {
        document.querySelectorAll('.val').forEach(el => el.classList.toggle('blur'));
    }

    function clearCache() {
        if(confirm("Deseja apagar os dados salvos no navegador?")) {
            localStorage.removeItem('investDash_v10');
            location.reload();
        }
    }
</script>
</body>
</html>
