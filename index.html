<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestDash Master AI - Final Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --primary: #6366f1; --accent: #8b5cf6;
            --success: #10b981; --danger: #ef4444; --text: #f8fafc; --sub: #94a3b8;
        }
        * { box-sizing: border-box; transition: 0.2s; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .ai-header { background: linear-gradient(135deg, #4f46e5, #9333ea); padding: 30px; border-radius: 30px; margin-bottom: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .ai-report { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 20px; margin-top: 15px; font-style: italic; line-height: 1.6; border-left: 4px solid #fff; font-size: 14px; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .s-card { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid #334155; }
        .s-card span { color: var(--sub); font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .s-card h2 { font-size: 22px; margin-top: 8px; font-weight: 800; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 25px; }
        @media(min-width: 1024px) { .grid { grid-template-columns: 2fr 1.2fr; } }
        .box { background: var(--card); padding: 25px; border-radius: 24px; border: 1px solid #334155; }

        .table-wrapper { overflow-x: auto; background: var(--card); border-radius: 24px; border: 1px solid #334155; padding: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; color: var(--sub); font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #334155; }
        td { padding: 15px; border-bottom: 1px solid #334155; font-size: 14px; font-weight: 600; }

        .btn-upload { background: #fff; color: #000; padding: 12px 24px; border-radius: 14px; font-weight: 800; cursor: pointer; border: none; font-size: 14px; }
        .btn-upload:hover { transform: scale(1.05); }
        .up { color: var(--success); } .down { color: var(--danger); }
        .badge { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="ai-header">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 15px;">
            <h1 style="margin:0; font-size: 24px;">InvestDash <span style="font-weight:400">AI Master</span></h1>
            <div style="display: flex; gap: 10px;">
                <label for="fIn" class="btn-upload">Atualizar Planilha</label>
                <button onclick="clearData()" class="btn-upload" style="background: rgba(255,255,255,0.2); color: #fff;">Limpar</button>
            </div>
            <input type="file" id="fIn" accept=".xlsx">
        </div>
        <div class="ai-report" id="aiRelatorio">
            ü§ñ <b>Analista IA:</b> Aguardando conex√£o com sua planilha para gerar o relat√≥rio estrat√©gico...
        </div>
    </div>

    <div class="stats">
        <div class="s-card"><span>Patrim√¥nio Total</span><h2 id="pPat">R$ 0,00</h2></div>
        <div class="s-card"><span>Lucro + Dividendos</span><h2 id="pLuc" class="up">R$ 0,00</h2></div>
        <div class="s-card"><span>M√©dia Proventos</span><h2 id="pDiv">R$ 0,00</h2></div>
        <div class="s-card"><span>Yield on Cost</span><h2 id="pYoc">0,00%</h2></div>
    </div>

    <div class="grid">
        <div class="box">
            <h3 style="margin-top:0">Evolu√ß√£o Patrimonial</h3>
            <canvas id="cLine" height="300"></canvas>
        </div>
        <div class="box">
            <h3 style="margin-top:0">Divis√£o por Ativo</h3>
            <canvas id="cRisk" height="300"></canvas>
        </div>
    </div>

    <div class="table-wrapper">
        <h3 style="margin-top:0">Raio-X da Carteira (Intelig√™ncia Artificial)</h3>
        <table id="tMain">
            <thead>
                <tr>
                    <th>Ativo</th>
                    <th>Qtd</th>
                    <th>Margem</th>
                    <th>Rend. Total</th>
                    <th>Pre√ßo Teto IA</th>
                    <th>Decis√£o</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let raw = {}; 
    let charts = {};
    const brl = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

    // Carregamento autom√°tico ao abrir a p√°gina
    window.onload = () => {
        const savedData = localStorage.getItem('investDashData');
        if (savedData) {
            raw = JSON.parse(savedData);
            execIA();
            document.getElementById('aiRelatorio').innerHTML += "<br><small style='opacity:0.7'>‚úÖ Dados restaurados da mem√≥ria local.</small>";
        }
    };

    document.getElementById('fIn').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = evt => {
            const wb = XLSX.read(evt.target.result, {type:'binary'});
            raw = {
                c: XLSX.utils.sheet_to_json(wb.Sheets["CARTEIRA"]),
                d: XLSX.utils.sheet_to_json(wb.Sheets["DIVIDENDOS"]),
                o: XLSX.utils.sheet_to_json(wb.Sheets["OPERA√á√ïES"])
            };
            // Salva os dados no navegador
            localStorage.setItem('investDashData', JSON.stringify(raw));
            execIA();
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    function clearData() {
        if(confirm("Deseja apagar os dados salvos neste navegador?")) {
            localStorage.removeItem('investDashData');
            location.reload();
        }
    }

    function execIA() {
        if(!raw.c) return;
        const cart = raw.c.filter(i => i.ATIVO);
        const totalPat = cart.reduce((a,b) => a + (parseFloat(b['CART. ATUAL'])||0), 0);
        const totalInv = cart.reduce((a,b) => a + (parseFloat(b['CUSTO TOTAL'])||0), 0);
        const totalDiv = raw.d.reduce((a,b) => a + (parseFloat(b.Valor)||0), 0);
        const meses = [...new Set(raw.d.map(d => d.M√äS))].length || 1;
        const rendaM = totalDiv / meses;

        document.getElementById('pPat').innerText = brl(totalPat);
        document.getElementById('pLuc').innerText = brl((totalPat - totalInv) + totalDiv);
        document.getElementById('pDiv').innerText = brl(rendaM);
        document.getElementById('pYoc').innerText = ((totalDiv/totalInv)*100).toFixed(2) + "%";

        // L√≥gica de Insights IA
        const topAtivo = cart.sort((a,b) => (parseFloat(b.DIVIDENDOS)) - (parseFloat(a.DIVIDENDOS)))[0];
        document.getElementById('aiRelatorio').innerHTML = `ü§ñ <b>Analista IA:</b> An√°lise de mercado conclu√≠da. Seu maior gerador de renda passiva acumulada √© <b>${topAtivo.ATIVO}</b>. 
        Com base na sua m√©dia de proventos de ${brl(rendaM)}, voc√™ est√° construindo uma base s√≥lida de independ√™ncia. 
        Mantenha aportes em ativos que estejam abaixo do <b>Pre√ßo Teto IA</b> indicado na tabela abaixo.`;

        renderTable(cart);
        renderCharts(totalInv, totalPat, cart);
    }

    function renderTable(cart) {
        const tb = document.querySelector('#tMain tbody');
        tb.innerHTML = '';
        cart.forEach(at => {
            const pm = parseFloat(at['PRE√áO M√âDIO']) || 0;
            const cot = parseFloat(at['COTA√á√ÉO ATUAL']) || 0;
            const teto = (parseFloat(at.DIVIDENDOS)/at['QTDE ATUAL'])/0.06 || 0;
            const margem = pm > 0 ? ((cot / pm - 1) * 100).toFixed(1) : 0;
            
            tb.innerHTML += `<tr>
                <td><b>${at.ATIVO}</b><br><small style="color:var(--sub)">${at.SEGMENTO}</small></td>
                <td>${at['QTDE ATUAL']}</td>
                <td class="${margem < 0 ? 'up' : 'down'}">${margem}%</td>
                <td>${brl(at.DIVIDENDOS)}</td>
                <td>${brl(teto)}</td>
                <td><b class="${cot < teto ? 'up' : 'down'}">${cot < teto ? 'üöÄ COMPRA' : '‚úã AGUARDAR'}</b></td>
            </tr>`;
        });
    }

    function renderCharts(inv, pat, cart) {
        if(charts.l) charts.l.destroy();
        charts.l = new Chart(document.getElementById('cLine'), {
            type: 'bar',
            data: { labels: ['Custo Total', 'Valor Mercado'], datasets: [{ data: [inv, pat], backgroundColor: ['#334155', '#6366f1'], borderRadius: 10 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        const s = {}; cart.forEach(c => s[c.ATIVO] = (s[c.ATIVO] || 0) + c['CART. ATUAL']);
        if(charts.r) charts.r.destroy();
        charts.r = new Chart(document.getElementById('cRisk'), {
            type: 'doughnut',
            data: { labels: Object.keys(s), datasets: [{ data: Object.values(s), backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'], borderWidth: 0 }] },
            options: { cutout: '75%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: { size: 10 } } } } }
        });
    }
</script>
</body>
</html>
        const filtro = document.getElementById('tipoFiltro').value;
        const carteira = db.cart.filter(i => i.ATIVO && (filtro === 'TODOS' || i.TIPO === filtro));
        
        // C√°lculos Base
        const pat = carteira.reduce((a, b) => a + (parseFloat(b['CART. ATUAL']) || 0), 0);
        const inv = carteira.reduce((a, b) => a + (parseFloat(b['CUSTO TOTAL']) || 0), 0);
        const prov = db.div.filter(d => carteira.some(c => c.ATIVO === d.ATIVO)).reduce((a, b) => a + (parseFloat(b.Valor) || 0), 0);
        const meses = [...new Set(db.div.map(d => d.M√äS))].length || 1;

        // Update KPIs
        document.getElementById('vPat').innerText = money(pat);
        document.getElementById('vDiv').innerText = money(prov);
        document.getElementById('vYoC').innerText = ((prov / (inv || 1)) * 100).toFixed(2) + '%';
        document.getElementById('vEqui').innerText = money(prov / meses);

        renderTable(carteira);
        renderCharts(inv, pat, carteira);
        document.getElementById('status').innerText = "An√°lise Elite Ativa ‚Ä¢ " + new Date().toLocaleTimeString();
    }

    function renderTable(data) {
        const body = document.querySelector('#tableAtivos tbody');
        body.innerHTML = '';
        data.forEach(at => {
            const pm = parseFloat(at['PRE√áO M√âDIO']) || 0;
            const cot = parseFloat(at['COTA√á√ÉO ATUAL']) || 0;
            const yoc = (pm > 0) ? ((parseFloat(at.DIVIDENDOS) / (pm * at['QTDE ATUAL'])) * 100).toFixed(2) : 0;
            const margem = pm > 0 ? ((cot / pm - 1) * 100).toFixed(1) : 0;
            
            // L√≥gica Bola de Neve (Rendimento mensal cobre 1 cota)
            const rendMensal = (parseFloat(at.DIVIDENDOS) / 12) || 0;
            const snowball = rendMensal >= cot;

            body.innerHTML += `
                <tr>
                    <td><b>${at.ATIVO}</b><br><small style="color:var(--text-sub)">${at.SEGMENTO}</small></td>
                    <td>${money(pm)}</td>
                    <td>${money(cot)}</td>
                    <td style="color:${margem < 0 ? 'var(--success)' : 'var(--danger)'}">${margem}%</td>
                    <td>${yoc}%</td>
                    <td><span class="badge ${snowball ? 'b-buy' : 'b-hold'}">${snowball ? 'SIM (1+ Cota)' : 'N√£o'}</span></td>
                    <td><span class="badge ${margem < 0 ? 'b-buy' : 'b-danger'}">${margem < 0 ? 'COMPRAR' : 'AGUARDAR'}</span></td>
                </tr>
            `;
        });
    }

    function renderCharts(inv, pat, cart) {
        if(charts.l) charts.l.destroy();
        charts.l = new Chart(document.getElementById('chartLine'), {
            type: 'line',
            data: {
                labels: ['In√≠cio', 'Hoje'],
                datasets: [
                    { label: 'Custo Total', data: [0, inv], borderColor: '#a3aed0', borderDash: [5,5], fill: false },
                    { label: 'Patrim√¥nio', data: [0, pat], borderColor: '#4318ff', backgroundColor: 'rgba(67, 24, 255, 0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        const sets = {}; cart.forEach(c => sets[c.SEGMENTO] = (sets[c.SEGMENTO] || 0) + c['CART. ATUAL']);
        if(charts.d) charts.d.destroy();
        charts.d = new Chart(document.getElementById('chartDoughnut'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(sets),
                datasets: [{ data: Object.values(sets), backgroundColor: ['#4318ff', '#0ea5e9', '#10b981', '#f59e0b', '#ee5d50', '#7551ff'], borderWidth: 0 }]
            },
            options: { cutout: '80%', responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });
    }
</script>
</body>
</html>
