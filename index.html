<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InvestDash Predictive v11.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #080b14; --card: #111827; --primary: #8b5cf6; --accent: #06b6d4;
            --success: #10b981; --danger: #f43f5e; --text: #f9fafb; --sub: #9ca3af; --border: #1f2937;
        }
        * { box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; padding: 10px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* Glassmorphism Effect */
        .glass-panel { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 24px; padding: 25px; margin-bottom: 20px; }
        
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .box { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 20px; position: relative; }
        
        /* AI Insights Header */
        .ai-intelligence { background: linear-gradient(90deg, #4c1d95, #1e3a8a); border-radius: 20px; padding: 20px; margin-bottom: 20px; border-left: 6px solid var(--accent); }
        .ai-badge { background: var(--accent); color: #000; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; margin-bottom: 10px; display: inline-block; }

        .stat-val { font-size: 24px; font-weight: 800; display: block; margin-top: 5px; }
        .stat-label { font-size: 12px; color: var(--sub); text-transform: uppercase; font-weight: 600; }

        /* Buttons */
        .btn { padding: 12px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; transition: 0.3s; font-size: 13px; }
        .btn-ai { background: var(--primary); color: white; box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4); }
        .btn-risk { background: rgba(244, 63, 94, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: var(--sub); font-size: 11px; padding: 12px; border-bottom: 1px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; }

        .progress-bar { height: 8px; background: #1f2937; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: 1s ease; }
        
        .hidden { display: none; }
        .blur { filter: blur(8px); }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="glass-panel" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:15px;">
        <div>
            <h1 style="margin:0; font-size:24px;">InvestDash <span style="color:var(--accent)">Predictive AI</span></h1>
            <p style="color:var(--sub); margin:5px 0 0; font-size:12px;">Vers√£o 11.0 ‚Ä¢ Gest√£o Ativa de Risco</p>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="togglePrivacy()" class="btn btn-risk" style="border:1px solid var(--sub); color:var(--text)">üëÅÔ∏è Privacidade</button>
            <button onclick="simulateCrisis()" class="btn btn-risk">‚ö†Ô∏è Stress Test</button>
            <label for="fIn" class="btn btn-ai">üîå Importar Dados</label>
            <input type="file" id="fIn" accept=".xlsx">
        </div>
    </div>

    <div class="ai-intelligence" id="aiBox">
        <span class="ai-badge">IA PREDICTIVE ENGINE</span>
        <div id="aiText" style="font-size:14px; line-height:1.6;">Aguardando dados para realizar a an√°lise preditiva da carteira...</div>
    </div>

    <div class="grid-3">
        <div class="box">
            <span class="stat-label">Patrim√≥nio Total</span>
            <span class="stat-val privacy" id="vPat">R$ 0,00</span>
            <div class="progress-bar"><div id="pBar" class="progress-fill"></div></div>
            <small id="pMeta" style="font-size:10px; color:var(--sub); margin-top:5px; display:block">Meta: R$ 100.000,00</small>
        </div>
        <div class="box">
            <span class="stat-label">Dividendos Estimados (Pr√≥x. M√™s)</span>
            <span class="stat-val privacy" id="vDivEst" style="color:var(--success)">R$ 0,00</span>
            <small style="font-size:10px; color:var(--sub)">Baseado em sazonalidade hist√≥rica</small>
        </div>
        <div class="box">
            <span class="stat-label">√çndice de Diversifica√ß√£o</span>
            <span class="stat-val" id="vDivScore">0%</span>
            <small id="vDivText" style="font-size:10px; color:var(--sub)">Carregue dados para avaliar o risco</small>
        </div>
    </div>

    <div class="grid-3" style="grid-template-columns: 2fr 1fr;">
        <div class="box">
            <h3 style="margin-top:0; font-size:16px;">Sugest√£o de Aporte IA (Rebalanceamento)</h3>
            <table id="rebalanceTable">
                <thead>
                    <tr>
                        <th>Ativo</th>
                        <th>Peso Atual</th>
                        <th>Peso Alvo</th>
                        <th>Sugest√£o IA</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="box">
            <h3 style="margin-top:0; font-size:16px;">Risco por Setor</h3>
            <canvas id="cRisk" height="200"></canvas>
        </div>
    </div>

    <div class="box" style="overflow-x:auto;">
        <h3 style="margin-top:0; font-size:16px;">Monitor de Ativos</h3>
        <table id="mainTable">
            <thead>
                <tr>
                    <th>Ativo</th>
                    <th>Pre√ßo M√©dio</th>
                    <th>Cota√ß√£o</th>
                    <th>Pre√ßo Teto IA</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let db = {}; let charts = {};
    const fmt = v => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

    window.onload = () => {
        const saved = localStorage.getItem('investDash_v11');
        if(saved) { db = JSON.parse(saved); runAI(); }
    };

    document.getElementById('fIn').addEventListener('change', e => {
        const reader = new FileReader();
        reader.onload = evt => {
            const wb = XLSX.read(evt.target.result, {type:'binary'});
            db = {
                c: XLSX.utils.sheet_to_json(wb.Sheets["CARTEIRA"]),
                d: XLSX.utils.sheet_to_json(wb.Sheets["DIVIDENDOS"])
            };
            localStorage.setItem('investDash_v11', JSON.stringify(db));
            runAI();
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    function runAI() {
        if(!db.c) return;
        const cart = db.c.filter(i => i.ATIVO);
        const total = cart.reduce((a,b) => a + (parseFloat(b['CART. ATUAL'])||0), 0);
        const totalDiv = db.d.reduce((a,b) => a + (parseFloat(b.Valor)||0), 0);
        
        // 1. Meta & KPIs
        document.getElementById('vPat').innerText = fmt(total);
        const pMeta = Math.min(100, (total / 100000) * 100);
        document.getElementById('pBar').style.width = pMeta + "%";
        document.getElementById('metaPct')?.innerText || (document.getElementById('pMeta').innerText = `Meta: R$ 100.000,00 (${pMeta.toFixed(1)}%)`);

        // 2. IA: Estimativa Pr√≥ximo M√™s
        const lastMonth = db.d.slice(-10).reduce((a,b) => a + (parseFloat(b.Valor)||0), 0) / 10;
        document.getElementById('vDivEst').innerText = fmt(lastMonth * 1.05); // IA simula 5% de crescimento

        // 3. IA: Score de Diversifica√ß√£o
        const setores = [...new Set(cart.map(i => i.SEGMENTO))].length;
        const score = Math.min(100, (setores * 15));
        document.getElementById('vDivScore').innerText = score + "%";
        document.getElementById('vDivText').innerText = score > 70 ? "Excelente diversifica√ß√£o" : "Risco de concentra√ß√£o alto";

        // 4. IA: Insights de Texto
        const melhor = cart.sort((a,b) => b['VARIA√á√ÉO %'] - a['VARIA√á√ÉO %'])[0];
        document.getElementById('aiText').innerHTML = `<b>Diagn√≥stico:</b> A sua carteira est√° com ${setores} setores ativos. O ativo <b>${melhor.ATIVO}</b> √© o seu maior destaque positivo. 
        <b>A√ß√£o Sugerida:</b> O rebalanceador indica que voc√™ deve focar os pr√≥ximos aportes em setores de menor peso para reduzir a volatilidade.`;

        renderTables(cart, total);
        renderCharts(cart);
    }

    function renderTables(cart, total) {
        const tbMain = document.querySelector('#mainTable tbody');
        const tbReb = document.querySelector('#rebalanceTable tbody');
        tbMain.innerHTML = ''; tbReb.innerHTML = '';

        const idealWeight = 1 / cart.length;

        cart.forEach(at => {
            const currentWeight = (parseFloat(at['CART. ATUAL']) || 0) / total;
            const needsAporte = currentWeight < idealWeight;
            const teto = (parseFloat(at.DIVIDENDOS)/at['QTDE ATUAL'])/0.06 || 0;
            const cot = parseFloat(at['COTA√á√ÉO ATUAL']) || 0;

            // Tabela Principal
            tbMain.innerHTML += `<tr>
                <td><b>${at.ATIVO}</b></td>
                <td class="privacy">${fmt(at['PRE√áO M√âDIO'])}</td>
                <td class="privacy">${fmt(cot)}</td>
                <td class="privacy">${fmt(teto)}</td>
                <td><span style="color:${cot < teto ? 'var(--success)' : 'var(--sub)'}">${cot < teto ? 'üî• COMPRA' : 'HOLD'}</span></td>
            </tr>`;

            // Tabela Rebalanceamento
            if(needsAporte) {
                tbReb.innerHTML += `<tr>
                    <td>${at.ATIVO}</td>
                    <td>${(currentWeight*100).toFixed(1)}%</td>
                    <td>${(idealWeight*100).toFixed(1)}%</td>
                    <td style="color:var(--accent)">ADICIONAR</td>
                </tr>`;
            }
        });
    }

    function renderCharts(cart) {
        const s = {}; cart.forEach(c => s[c.SEGMENTO] = (s[c.SEGMENTO] || 0) + (parseFloat(c['CART. ATUAL'])||0));
        if(charts.r) charts.r.destroy();
        charts.r = new Chart(document.getElementById('cRisk'), {
            type: 'doughnut',
            data: { labels: Object.keys(s), datasets: [{ data: Object.values(s), backgroundColor: ['#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#f43f5e'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function togglePrivacy() {
        document.querySelectorAll('.privacy').forEach(el => el.classList.toggle('blur'));
    }

    function simulateCrisis() {
        if(!confirm("Simular queda de 20% no mercado (Stress Test)?")) return;
        const val = document.getElementById('vPat');
        const original = val.innerText;
        const current = parseFloat(original.replace(/[^\d,]/g, '').replace(',', '.'));
        val.innerText = fmt(current * 0.8);
        val.style.color = "var(--danger)";
        setTimeout(() => { 
            alert("Este seria o seu patrim√≥nio numa crise. Mantenha a calma e os dividendos continuar√£o caindo!");
            val.innerText = original;
            val.style.color = "var(--text)";
        }, 3000);
    }
</script>
</body>
</html>
